# RDB 持久化

RDB 文件的内容是二进制数据

Redis 提供了两个命令来生成 RDB 文件：
- save 直接在主线程生成 RDB 文件，因此如果写入 RDB 文件时间太长，会阻塞主线程执行命令
- bgsave 会创建一个子进程来生成 RDB 文件  

Redis 也可以通过配置文件 来实现每隔一段时间自动执行一次 bgsave 命令
```rdb
save 900 1  // 900s 之内，对数据库至少进行了 1 次修改
save 300 10 // 300s 之内，对数据库至少进行了 10 次修改
save 60 10000   // 60 秒之内，对数据库至少进行了 10000 次修改
```
Redis 的快照是一个全量快照，即直接把内存中的 **所有数据** 同步到磁盘上

频率太高，影响效率；频率太低，服务器故障时会丢失大量数据

bgsave 的实现和 AOF 后台重写有些相似。都是通过 Fork 一个子进程，来实现数据的同步  

当子进程同步时，主进程执行了写操作命令，这会对相应的内存块进行复制，但是修改并不会同步到 RDB 文件中，
因此 RDB 文件保存的是旧数据，更新后的数据只能通过下次 bgsave 同步到 RDB 中。因此倘若这个过程中主机断电了则会造成数据丢失

**RDB 和 AOF 混合使用**  
当开启了混合持久化时，在 AOF 重写日志时，fork 出来的重写子进程会先将与主线程共享的内存数据以 RDB 方式写入到 AOF 文件，然后主线程处理的操作命令会被记录在重写缓冲区里，重写缓冲区里的增量命令会以 AOF 方式写入到 AOF 文件，写入完成后通知主进程将新的含有 RDB 格式和 AOF 格式的 AOF 文件替换旧的的 AOF 文件。

也就是说，使用了混合持久化，AOF 文件的前半部分是 RDB 格式的全量数据，后半部分是 AOF 格式的增量数据。