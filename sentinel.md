# 哨兵

目前有主从服务器，倘若主服务器挂了呢？我们需要手动选出一个服务器作为主服务器，并将其他从服务器改到这个主服务器下面，哨兵就是帮我们做这件事

哨兵是一个运作在特殊模式下的 Redis 进程，它也是一个节点。主要工作:
- 监视
- 选主
- 通知

**如何判断主节点是真的故障了呢?**  
哨兵会每隔 1s 就像就像主服务器发送 ping 命令，如果没有在规定的时间内收到响应，就将它标记为**主观下线**  

规定的时间是配置项 **down-after-milliseconds**   

但是不能通过主观下线就判断主服务器是真的故障了，毕竟网络状况、服务器忙等情况
因此需要组成一个哨兵团(至少 3 个哨兵)来进行判断  

当有哨兵团里面的 2/1 都收不到服务器响应的时候，就会标记服务器为**客观下线**
哨兵间会互相通信，当赞成主管下线的数量大于等于 哨兵团的 1/2+1 时，就会标记为客观下线。也可设置哨兵配置文件赞成 quorum 参数   

**哪个哨兵是 leader?**
主服务下线判断出来了，那么让哪个哨兵去进行故障转移呢？因此需要在哨兵集群中推选出一个主哨兵

- 判断主观下线的哨兵都可以投自己一票
- 每个人只有一票
- 得票多的成为主哨兵
- 拿到半数以上的票数，且大于等于配置文件中的 quorum 值
- 如果哨兵选举难以推选出主哨兵，则需要人为参与或添加新的哨兵

**主从故障转移过程**     
- 选出新的主节点    
网络状态，优先级，offset，节点ID
- 让所有从节点都跟随这个主节点
- 把新节点的 IP 信息通过 发布/订阅 模式发给客户端
- 继续监视旧主节点，重新上线后使之变成新主节点的从节点  

**哨兵集群如何组成**
通过 Redis 的发布/订阅机制来互相发现的.**__sentinel__:hello频道**